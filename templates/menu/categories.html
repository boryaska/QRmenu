{% extends 'base.html' %}

{% block title %}Категории меню - QR Menu{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- CSRF token для AJAX -->
    {% csrf_token %}
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                Категории меню
            </h2>
            <p class="mt-1 text-sm text-gray-500">
                Управляйте категориями блюд вашего ресторана
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4">
            <a href="{% url 'menu:category_create' %}"
               class="bg-indigo-600 text-white px-6 py-3 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors duration-200 shadow-sm">
                <i class="fas fa-plus mr-2"></i>
                Добавить категорию
            </a>
        </div>
    </div>

    {% if categories %}
        <!-- Сетка категорий -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for category in categories %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow duration-200 group">
                <!-- Изображение категории - кликабельная -->
                <div class="relative h-48 bg-gradient-to-br from-indigo-100 to-purple-100 cursor-pointer"
                     onclick="window.location.href='{% url 'menu:dishes' %}?category={{ category.pk }}'">
                    {% if category.image %}
                        <img src="{{ category.image.url }}" alt="{{ category.name }}"
                             class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center">
                            <i class="fas fa-utensils text-4xl text-indigo-300"></i>
                        </div>
                    {% endif %}

                    <!-- Статус категории -->
                    {% if not category.is_active %}
                        <div class="absolute top-3 right-3">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Неактивна
                            </span>
                        </div>
                    {% endif %}

                    <!-- Кнопки действий -->
                    <div class="absolute top-3 left-3 flex space-x-2">
                        <button class="action-button bg-white p-2 rounded-full shadow-sm hover:bg-gray-50 transition-colors duration-200"
                                title="Редактировать"
                                onclick="event.stopPropagation(); window.location.href='{% url 'menu:category_edit' category.pk %}';">
                            <i class="fas fa-edit text-indigo-600 text-sm"></i>
                        </button>
                        <button class="action-button bg-white p-2 rounded-full shadow-sm hover:bg-red-50 transition-colors duration-200"
                                title="Удалить"
                                onclick="event.stopPropagation(); if(confirm('Удалить категорию {{ category.name }}?')) window.location.href='{% url 'menu:category_delete' category.pk %}';">
                            <i class="fas fa-trash text-red-600 text-sm"></i>
                        </button>
                        {% if category.is_active %}
                        <button class="action-button bg-white p-2 rounded-full shadow-sm hover:bg-orange-50 transition-colors duration-200"
                                title="Скрыть с меню"
                                onclick="event.stopPropagation(); toggleCategoryActive({{ category.pk }}, false, this);">
                            <i class="fas fa-eye-slash text-orange-600 text-sm"></i>
                        </button>
                        {% else %}
                        <button class="action-button bg-white p-2 rounded-full shadow-sm hover:bg-green-50 transition-colors duration-200"
                                title="Показать в меню"
                                onclick="event.stopPropagation(); toggleCategoryActive({{ category.pk }}, true, this);">
                            <i class="fas fa-eye text-green-600 text-sm"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Содержимое карточки -->
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ category.name }}</h3>
                    {% if category.description %}
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">{{ category.description|truncatewords:15 }}</p>
                    {% endif %}

                    <!-- Количество блюд -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">
                            <i class="fas fa-utensils mr-1"></i>
                            {{ category.dishes_count }} блюд
                        </span>

                        <!-- Кнопка просмотра блюд -->
                        <a href="{% url 'menu:dishes' %}?category={{ category.pk }}"
                           class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 transition-colors duration-200">
                            Просмотреть
                            <i class="fas fa-arrow-right ml-1"></i>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-16">
            <div class="mx-auto max-w-md">
                <div class="text-gray-400 mb-6">
                    <i class="fas fa-list text-6xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Нет категорий</h3>
                <p class="text-gray-500 mb-8">
                    Начните с создания первой категории блюд для вашего меню.
                </p>
                <a href="{% url 'menu:category_create' %}"
                   class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors duration-200 shadow-sm">
                    <i class="fas fa-plus mr-2"></i>
                    Создать категорию
                </a>
            </div>
        </div>
    {% endif %}
</div>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.action-button {
    transition: all 0.2s ease;
}

.action-button:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
</style>

<script>
function toggleCategoryActive(categoryId, isActive, element) {
    // Показываем загрузку
    const originalIcon = element.querySelector('i');
    const originalClass = originalIcon.className;
    originalIcon.className = 'fas fa-spinner fa-spin text-gray-600 text-sm';

    // Отправляем запрос
    fetch(`/dashboard/menu/categories/${categoryId}/toggle-active/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
            is_active: isActive
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Находим элементы для обновления
            const card = element.closest('.group');
            const statusBadge = card.querySelector('.absolute.top-3.right-3');

            if (data.is_active) {
                // Категория стала активной
                if (statusBadge) statusBadge.remove();
                element.innerHTML = '<i class="fas fa-eye-slash text-orange-600 text-sm"></i>';
                element.setAttribute('title', 'Скрыть с меню');
                element.onclick = function(e) {
                    e.stopPropagation();
                    toggleCategoryActive(categoryId, false, this);
                };
            } else {
                // Категория стала неактивной
                if (!statusBadge) {
                    const newBadge = document.createElement('div');
                    newBadge.className = 'absolute top-3 right-3';
                    newBadge.innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Неактивна</span>';
                    card.querySelector('.relative.h-48').appendChild(newBadge);
                }
                element.innerHTML = '<i class="fas fa-eye text-green-600 text-sm"></i>';
                element.setAttribute('title', 'Показать в меню');
                element.onclick = function(e) {
                    e.stopPropagation();
                    toggleCategoryActive(categoryId, true, this);
                };
            }

            // Показываем сообщение
            showMessage(data.message, 'success');
        } else {
            showMessage('Ошибка при изменении статуса категории', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Произошла ошибка', 'error');
    })
    .finally(() => {
        // Возвращаем исходную иконку
        originalIcon.className = originalClass;
    });
}

function showMessage(message, type = 'info') {
    // Создаем элемент сообщения
    const messageDiv = document.createElement('div');
    messageDiv.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium shadow-lg transform transition-all duration-300 translate-x-full`;
    messageDiv.style.maxWidth = '400px';

    if (type === 'success') {
        messageDiv.className += ' bg-green-500';
    } else if (type === 'error') {
        messageDiv.className += ' bg-red-500';
    } else {
        messageDiv.className += ' bg-blue-500';
    }

    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);

    // Анимация появления
    setTimeout(() => {
        messageDiv.classList.remove('translate-x-full');
        messageDiv.classList.add('translate-x-0');
    }, 10);

    // Автоматическое исчезновение
    setTimeout(() => {
        messageDiv.classList.remove('translate-x-0');
        messageDiv.classList.add('translate-x-full');
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
