{% extends 'base.html' %}

{% block title %}Блюда меню - QR Menu{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Заголовок и навигация -->
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="flex-1 min-w-0">
            <div class="flex items-center space-x-3">
                <a href="{% url 'menu:categories' %}"
                   class="text-indigo-600 hover:text-indigo-800 transition-colors duration-200">
                    <i class="fas fa-arrow-left mr-1"></i>
                    Категории
                </a>
                <span class="text-gray-400">/</span>
                <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                    {% if current_category %}
                        {{ current_category.name }}
                    {% else %}
                        Блюда меню
                    {% endif %}
                </h2>
            </div>
            {% if current_category and current_category.description %}
                <p class="mt-1 text-sm text-gray-500">{{ current_category.description }}</p>
            {% else %}
                <p class="mt-1 text-sm text-gray-500">Управляйте блюдами вашего ресторана</p>
            {% endif %}
        </div>
        <div class="mt-4 flex space-x-3 md:mt-0 md:ml-4">
            <a href="{% url 'menu:dish_create' %}{% if current_category %}?category={{ current_category.pk }}{% endif %}"
               class="bg-indigo-600 text-white px-6 py-3 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors duration-200 shadow-sm">
                <i class="fas fa-plus mr-2"></i>
                Добавить блюдо
            </a>
        </div>
    </div>

    {% if dishes %}


        <!-- Сетка блюд -->
        <div class="dishes-grid">
            {% for dish in dishes %}
            <!-- Вся карточка кликабельна -->
            <a href="{% url 'menu:dish_detail' dish.pk %}"
               class="dish-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-all duration-200 group block">
                <!-- Изображение блюда -->
                <div class="relative h-48 bg-gradient-to-br from-green-100 to-blue-100">
                    {% if dish.image %}
                        <img src="{{ dish.image.url }}" alt="{{ dish.name }}"
                             class="w-full h-full object-cover">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center">
                            <i class="fas fa-utensils text-4xl text-green-300"></i>
                        </div>
                    {% endif %}

                    <!-- Статус блюда -->
                    {% if not dish.is_available %}
                        <div class="dish-status">
                            Недоступно
                        </div>
                    {% endif %}

                    <!-- Кнопки действий -->
                    <div class="action-buttons">
                        <button class="action-button" title="Редактировать"
                                onclick="event.stopPropagation(); window.location.href='{% url 'menu:dish_edit' dish.pk %}';">
                            <i class="fas fa-edit text-indigo-600 text-sm"></i>
                        </button>
                        <button class="action-button" title="Удалить"
                                onclick="event.stopPropagation(); if(confirm('Удалить блюдо {{ dish.name }}?')) window.location.href='{% url 'menu:dish_delete' dish.pk %}';">
                            <i class="fas fa-trash text-red-600 text-sm"></i>
                        </button>
                        {% if dish.is_available %}
                        <button class="action-button" title="Скрыть с меню"
                                onclick="event.stopPropagation(); toggleDishAvailability({{ dish.pk }}, false, this);">
                            <i class="fas fa-eye-slash text-orange-600 text-sm"></i>
                        </button>
                        {% else %}
                        <button class="action-button" title="Показать в меню"
                                onclick="event.stopPropagation(); toggleDishAvailability({{ dish.pk }}, true, this);">
                            <i class="fas fa-eye text-green-600 text-sm"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Содержимое карточки -->
                <div class="card-content">
                    <div class="flex items-start justify-between mb-3">
                        <h3 class="dish-title">{{ dish.name }}</h3>
                        <span class="dish-price">{{ dish.get_formatted_price }}</span>
                    </div>

                    <!-- Категория -->
                    <div class="dish-category">
                        <i class="fas fa-tag mr-1"></i>
                        {{ dish.category.name }}
                    </div>

                    <!-- Описание -->
                    {% if dish.description %}
                        <p class="dish-description">{{ dish.description }}</p>
                    {% endif %}

                    <!-- Вес/объем -->
                    {% if dish.get_formatted_weight %}
                        <div class="dish-weight">
                            <i class="fas fa-weight mr-1"></i>
                            {{ dish.get_formatted_weight }}
                        </div>
                    {% endif %}

                    <!-- Ингредиенты -->
                    {% if dish.ingredients %}
                        <div class="dish-ingredients">
                            <i class="fas fa-list-ul mr-1"></i>
                            {{ dish.ingredients|truncatechars:50 }}
                        </div>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-16">
            <div class="mx-auto max-w-md">
                <div class="text-gray-400 mb-6">
                    <i class="fas fa-utensils text-6xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">
                    {% if current_category %}
                        Нет блюд в категории "{{ current_category.name }}"
                    {% else %}
                        Нет блюд
                    {% endif %}
                </h3>
                <p class="text-gray-500 mb-8">
                    {% if current_category %}
                        Добавьте первое блюдо в эту категорию.
                    {% else %}
                        Начните с создания первого блюда для вашего меню.
                    {% endif %}
                </p>
                <a href="{% url 'menu:dish_create' %}{% if current_category %}?category={{ current_category.pk }}{% endif %}"
                   class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors duration-200 shadow-sm">
                    <i class="fas fa-plus mr-2"></i>
                    {% if current_category %}
                        Добавить блюдо в категорию
                    {% else %}
                        Создать блюдо
                    {% endif %}
                </a>
            </div>
        </div>
    {% endif %}
</div>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Сетка блюд с цельными карточками */
.dishes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    justify-items: center;
    align-items: start;
}

/* Адаптивность для мобильных устройств */
@media (max-width: 640px) {
    .dishes-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .dish-card {
        max-width: 100%;
        min-height: 320px;
    }
}

@media (min-width: 641px) and (max-width: 768px) {
    .dishes-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1.25rem;
    }

    .dish-card {
        max-width: 100%;
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .dishes-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
    }
}

@media (min-width: 1025px) {
    .dishes-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }
}

.dish-card {
    width: 100%;
    max-width: 280px;
    min-height: 380px;
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
}

.dish-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

/* Содержимое карточки */
.dish-card .card-content {
    flex: 1;
    padding: 1rem;
    display: flex;
    flex-direction: column;
}

/* Заголовок блюда */
.dish-card .dish-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.5rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Цена */
.dish-card .dish-price {
    font-size: 1.25rem;
    font-weight: bold;
    color: #059669;
    align-self: flex-start;
}

/* Категория */
.dish-card .dish-category {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    background-color: #eef2ff;
    color: #4338ca;
    margin-bottom: 0.5rem;
    align-self: flex-start;
}

/* Вес/объем */
.dish-card .dish-weight {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

/* Описание */
.dish-card .dish-description {
    font-size: 0.875rem;
    color: #4b5563;
    margin-bottom: 0.5rem;
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Ингредиенты */
.dish-card .dish-ingredients {
    font-size: 0.75rem;
    color: #6b7280;
}

/* Кнопки действий */
.dish-card .action-buttons {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    display: flex;
    gap: 0.5rem;
}

.dish-card .action-button {
    background: white;
    padding: 0.5rem;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.dish-card .action-button:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Статус блюда */
.dish-card .dish-status {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #374151;
    background-color: #f3f4f6;
}
</style>

<script>
function toggleDishAvailability(dishId, isAvailable, element) {
    // Показываем загрузку
    const originalIcon = element.querySelector('i');
    const originalClass = originalIcon.className;
    originalIcon.className = 'fas fa-spinner fa-spin text-gray-600 text-sm';

    // Отправляем AJAX запрос
    fetch(`/dashboard/menu/dishes/${dishId}/toggle-availability/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            is_available: isAvailable
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Обновляем иконку
            if (isAvailable) {
                element.title = 'Скрыть с меню';
                element.onclick = () => toggleDishAvailability(dishId, false, element);
                element.querySelector('i').className = 'fas fa-eye-slash text-orange-600 text-sm';
                element.closest('.group').querySelector('.bg-gray-100').style.display = 'none';
            } else {
                element.title = 'Показать в меню';
                element.onclick = () => toggleDishAvailability(dishId, true, element);
                element.querySelector('i').className = 'fas fa-eye text-green-600 text-sm';
                element.closest('.group').querySelector('.bg-gray-100').style.display = 'block';
            }
        } else {
            alert('Ошибка при обновлении статуса блюда');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при обновлении статуса');
        // Восстанавливаем оригинальную иконку
        originalIcon.className = originalClass;
    });
}
</script>
{% endblock %}
