{% extends 'base.html' %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.order_number }} - QR Menu{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-start mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">–ó–∞–∫–∞–∑ #{{ order.order_number }}</h1>
            <p class="text-gray-600">{{ order.created_at|date:"d.m.Y –≤ H:i" }}</p>
        </div>
        <div class="flex items-center space-x-3">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800
                {% elif order.status == 'confirmed' %}bg-blue-100 text-blue-800
                {% elif order.status == 'preparing' %}bg-orange-100 text-orange-800
                {% elif order.status == 'ready' %}bg-green-100 text-green-800
                {% elif order.status == 'completed' %}bg-gray-100 text-gray-800
                {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                {% endif %}">
                {{ order.get_status_display }}
            </span>
            
            {% if order.is_paid %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    –û–ø–ª–∞—á–µ–Ω
                </span>
            {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                    –ù–µ –æ–ø–ª–∞—á–µ–Ω
                </span>
            {% endif %}
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–º -->
    {% if order.status != 'completed' and order.status != 'cancelled' %}
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–º</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-3">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h4>
                <div class="space-y-2">
                    {% if order.status == 'pending' %}
                        <button onclick="updateStatus('confirmed')" 
                                class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                            ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                        <button onclick="updateStatus('cancelled')" 
                                class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">
                            ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    {% elif order.status == 'confirmed' %}
                        <button onclick="updateStatus('preparing')" 
                                class="w-full bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 transition">
                            üë®‚Äçüç≥ –ù–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤–∏—Ç—å
                        </button>
                        <button onclick="updateStatus('cancelled')" 
                                class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">
                            ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    {% elif order.status == 'preparing' %}
                        <button onclick="updateStatus('ready')" 
                                class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">
                            üçΩÔ∏è –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤
                        </button>
                    {% elif order.status == 'ready' %}
                        <button onclick="updateStatus('completed')" 
                                class="w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
                            ‚úÖ –ó–∞–∫–∞–∑ –≤—ã–¥–∞–Ω
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–ª–∞—Ç–æ–π -->
            {% if not order.is_paid %}
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-3">–û–ø–ª–∞—Ç–∞</h4>
                <div class="space-y-2">
                    <button onclick="updatePayment('cash')" 
                            class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">
                        üíµ –û–ø–ª–∞—á–µ–Ω–æ –Ω–∞–ª–∏—á–Ω—ã–º–∏
                    </button>
                    <button onclick="updatePayment('card')" 
                            class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                        üí≥ –û–ø–ª–∞—á–µ–Ω–æ –∫–∞—Ä—Ç–æ–π
                    </button>
                    <button onclick="updatePayment('online')" 
                            class="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition">
                        üì± –û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞
                    </button>
                </div>
            </div>
            {% else %}
            <div>
                <h4 class="text-sm font-medium text-gray-700 mb-3">–û–ø–ª–∞—Ç–∞</h4>
                <div class="flex items-center justify-center p-4 bg-green-50 rounded-lg">
                    <span class="text-green-600 font-medium">
                        ‚úÖ –ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω
                        {% if order.payment_method %}
                            ({{ order.get_payment_method_display }})
                        {% endif %}
                    </span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">–ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞</h3>
                </div>
                <div class="p-6">
                    {% for item in order.items.all %}
                    <div class="flex justify-between items-start py-3 {% if not forloop.last %}border-b border-gray-200{% endif %}">
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900">{{ item.dish.name }}</h4>
                            {% if item.dish.description %}
                            <p class="text-sm text-gray-600 mt-1">{{ item.dish.description }}</p>
                            {% endif %}
                            <p class="text-sm text-gray-500">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ item.quantity }}</p>
                        </div>
                        <span class="text-sm font-medium text-gray-900">{{ item.total_price }} ‚ÇΩ</span>
                    </div>
                    {% empty %}
                    <p class="text-gray-500">–í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π</p>
                    {% endfor %}
                    
                    <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                        <span class="text-lg font-medium text-gray-900">–ò—Ç–æ–≥–æ:</span>
                        <span class="text-lg font-bold text-gray-900">{{ order.total_amount }} ‚ÇΩ</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                <dl class="space-y-2">
                    {% if order.customer_name %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ò–º—è</dt>
                        <dd class="text-sm text-gray-900">{{ order.customer_name }}</dd>
                    </div>
                    {% endif %}
                    {% if order.customer_phone %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</dt>
                        <dd class="text-sm text-gray-900">{{ order.customer_phone }}</dd>
                    </div>
                    {% endif %}
                    {% if order.table_number %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–°—Ç–æ–ª</dt>
                        <dd class="text-sm text-gray-900">{{ order.table_number }}</dd>
                    </div>
                    {% endif %}
                    {% if order.special_requests %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</dt>
                        <dd class="text-sm text-gray-900">{{ order.special_requests }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>

    <div class="mt-8 flex justify-between">
        <a href="{% url 'orders:orders' %}" 
           class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
            ‚Üê –ö —Å–ø–∏—Å–∫—É –∑–∞–∫–∞–∑–æ–≤
        </a>
    </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notification" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
        <span id="notification-text"></span>
    </div>
</div>

<!-- –î–∞–Ω–Ω—ã–µ –¥–ª—è JavaScript -->
<div id="order-data" data-order-id="{{ order.pk }}" style="display: none;"></div>

<script>
// –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type) {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');
    
    notificationText.textContent = message;
    
    // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    const notificationDiv = notification.querySelector('div');
    if (type === 'success') {
        notificationDiv.className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
    } else if (type === 'error') {
        notificationDiv.className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
    }
    
    notification.classList.remove('hidden');
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(function() {
        notification.classList.add('hidden');
    }, 3000);
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
function updateStatus(newStatus) {
    const orderId = document.getElementById('order-data').getAttribute('data-order-id');
    
    fetch('/dashboard/orders/' + orderId + '/api/status/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: 'status=' + newStatus
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showNotification(data.message, 'success');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(function() {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
    });
}

// –û–±–Ω–æ–≤–∏—Ç—å –æ–ø–ª–∞—Ç—É –∑–∞–∫–∞–∑–∞
function updatePayment(paymentMethod) {
    const orderId = document.getElementById('order-data').getAttribute('data-order-id');
    
    fetch('/dashboard/orders/' + orderId + '/payment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: 'payment_method=' + paymentMethod
    })
    .then(function(response) {
        if (response.ok) {
            showNotification('–ó–∞–∫–∞–∑ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π', 'success');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(function() {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã', 'error');
    });
}
</script>
{% endblock %}
