{% extends 'base.html' %}

{% block title %}–ó–∞–∫–∞–∑—ã - QR Menu{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl">
            –ó–∞–∫–∞–∑—ã
        </h2>
        <p class="mt-1 text-sm text-gray-500">
            –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–∞–∫–∞–∑–∞–º–∏ –≤–∞—à–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        </p>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="mb-6 bg-white shadow rounded-lg p-4">
        <form method="get" class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-48">
                <input type="text" name="search" value="{{ request.GET.search }}" 
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, –∫–ª–∏–µ–Ω—Ç—É..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <select name="status" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</option>
                    <option value="confirmed" {% if request.GET.status == 'confirmed' %}selected{% endif %}>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
                    <option value="preparing" {% if request.GET.status == 'preparing' %}selected{% endif %}>–ì–æ—Ç–æ–≤–∏—Ç—Å—è</option>
                    <option value="ready" {% if request.GET.status == 'ready' %}selected{% endif %}>–ì–æ—Ç–æ–≤</option>
                    <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>–í—ã–ø–æ–ª–Ω–µ–Ω</option>
                    <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>–û—Ç–º–µ–Ω–µ–Ω</option>
                </select>
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å
            </button>
        </form>
    </div>

    {% if orders %}
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <ul class="divide-y divide-gray-200">
                {% for order in orders %}
                <li>
                    <div class="px-4 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-1">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center mb-2">
                                        <a href="{% url 'orders:order_detail' order.pk %}" 
                                           class="text-sm font-medium text-gray-900 hover:text-indigo-600">
                                            #{{ order.order_number }}
                                        </a>
                                        
                                        <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                            {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800
                                            {% elif order.status == 'confirmed' %}bg-blue-100 text-blue-800
                                            {% elif order.status == 'preparing' %}bg-orange-100 text-orange-800
                                            {% elif order.status == 'ready' %}bg-green-100 text-green-800
                                            {% elif order.status == 'completed' %}bg-gray-100 text-gray-800
                                            {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                                            {% endif %}">
                                            {{ order.get_status_display }}
                                        </span>

                                        {% if order.is_paid %}
                                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                üí∞ –û–ø–ª–∞—á–µ–Ω
                                            </span>
                                        {% else %}
                                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                üí≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="text-sm text-gray-600">
                                        <div class="flex items-center space-x-4">
                                            {% if order.customer_name %}
                                                <span>üë§ {{ order.customer_name }}</span>
                                            {% endif %}
                                            {% if order.table_number %}
                                                <span>ü™ë –°—Ç–æ–ª {{ order.table_number }}</span>
                                            {% endif %}
                                            <span>üïê {{ order.created_at|date:"d.m.Y H:i" }}</span>
                                            <span class="font-medium text-gray-900">{{ order.total_amount }} ‚ÇΩ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                            {% if order.status != 'completed' and order.status != 'cancelled' %}
                            <div class="flex items-center space-x-2 ml-4">
                                {% if order.status == 'pending' %}
                                    <button data-order-id="{{ order.pk }}" data-status="confirmed" onclick="updateOrderStatus(this)" 
                                            class="bg-blue-600 text-white px-3 py-1 text-xs rounded hover:bg-blue-700 transition">
                                        ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                                    </button>
                                    <button data-order-id="{{ order.pk }}" data-status="cancelled" onclick="updateOrderStatus(this)" 
                                            class="bg-red-600 text-white px-3 py-1 text-xs rounded hover:bg-red-700 transition">
                                        ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                                    </button>
                                {% elif order.status == 'confirmed' %}
                                    <button data-order-id="{{ order.pk }}" data-status="preparing" onclick="updateOrderStatus(this)" 
                                            class="bg-orange-600 text-white px-3 py-1 text-xs rounded hover:bg-orange-700 transition">
                                        üë®‚Äçüç≥ –ì–æ—Ç–æ–≤–∏—Ç—å
                                    </button>
                                {% elif order.status == 'preparing' %}
                                    <button data-order-id="{{ order.pk }}" data-status="ready" onclick="updateOrderStatus(this)" 
                                            class="bg-green-600 text-white px-3 py-1 text-xs rounded hover:bg-green-700 transition">
                                        üçΩÔ∏è –ì–æ—Ç–æ–≤
                                    </button>
                                {% elif order.status == 'ready' %}
                                    <button data-order-id="{{ order.pk }}" data-status="completed" onclick="updateOrderStatus(this)" 
                                            class="bg-gray-600 text-white px-3 py-1 text-xs rounded hover:bg-gray-700 transition">
                                        ‚úÖ –í—ã–¥–∞–Ω
                                    </button>
                                {% endif %}

                                {% if not order.is_paid %}
                                    <button data-order-id="{{ order.pk }}" onclick="markAsPaid(this)" 
                                            class="bg-green-600 text-white px-3 py-1 text-xs rounded hover:bg-green-700 transition">
                                        üí∞ –û–ø–ª–∞—á–µ–Ω
                                    </button>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if is_paginated %}
        <div class="mt-6 flex justify-center">
            <nav class="flex items-center space-x-2">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="px-3 py-2 text-sm text-gray-500 hover:text-gray-700">–ü–µ—Ä–≤–∞—è</a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-2 text-sm text-gray-500 hover:text-gray-700">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                {% endif %}
                
                <span class="px-3 py-2 text-sm text-gray-700">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-2 text-sm text-gray-500 hover:text-gray-700">–°–ª–µ–¥—É—é—â–∞—è</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="px-3 py-2 text-sm text-gray-500 hover:text-gray-700">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    {% else %}
        <div class="text-center py-12">
            <h3 class="mt-2 text-sm font-medium text-gray-900">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</h3>
            <p class="mt-1 text-sm text-gray-500">
                –ó–∞–∫–∞–∑—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º–∏.
            </p>
        </div>
    {% endif %}
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notification" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
        <span id="notification-text"></span>
    </div>
</div>

<script>
// –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type) {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');
    
    notificationText.textContent = message;
    
    // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    const notificationDiv = notification.querySelector('div');
    if (type === 'success') {
        notificationDiv.className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
    } else if (type === 'error') {
        notificationDiv.className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
    }
    
    notification.classList.remove('hidden');
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(function() {
        notification.classList.add('hidden');
    }, 3000);
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
function updateOrderStatus(button) {
    const orderId = button.dataset.orderId;
    const newStatus = button.dataset.status;

    fetch('/dashboard/orders/' + orderId + '/api/status/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: 'status=' + newStatus
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showNotification(data.message, 'success');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(function() {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
    });
}

// –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π
function markAsPaid(button) {
    const orderId = button.dataset.orderId;

    fetch('/dashboard/orders/' + orderId + '/payment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: 'payment_method=cash'
    })
    .then(function(response) {
        if (response.ok) {
            showNotification('–ó–∞–∫–∞–∑ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π', 'success');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(function() {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã', 'error');
    });
}
</script>
{% endblock %}
